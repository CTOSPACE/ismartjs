<div s="window" id="mainWindow">

</div>
<div id="loginDiv" class="login-window">
    <div class="modal-content" style="width: 500px; margin: 90px auto;">
        <div class="modal-header">
            <h4 class="modal-title" s-ui-dialog-role="title">iSmart JS</h4>
        </div>
        <div class="modal-body" s-ui-dialog-role="body" id="loginPanel" s="window"></div>
    </div>
</div>
<script type="text/javascript" >
    var Page = {};
    var href = window.location.href;
    var hash;
    if (href.indexOf("#") != -1) {
        hash = href.substring(href.indexOf("#") + 1);
    }
    var loginProcessStatus = 0;
    var loginRetryCallbacks = [];
    Page.Main = {
        menuUrl: "json/menu.json",
        defaultTabIcon: "glyphicon glyphicon-file",
        defaultMenuIcon: "",
        topbarRightUrl: "topbar-right.html",
        topbarLeftUrl: "topbar-left.html",
        bottomUrl: "main-bottom.html",
        handleAjaxError: function (e, errorTip, errorMsg, xhr) {
            if (xhr.status == 403) {
                e.stopPropagation();
                if (e.retryRequest) {
                    loginRetryCallbacks.push(e.retryRequest);
                }
                if (loginProcessStatus == 1) {
                    return;
                }
                //登陆超时
                loginProcessStatus = 1;
                S.popupOpen('login-panel.html').done(function (status) {
                    loginProcessStatus = 0;
                    if (status) {
                        $.each(loginRetryCallbacks, function (i, callback) {
                            callback();
                        })
                        loginRetryCallbacks = [];
                    }
                })
                return;
            }
            S.notice($.trim(errorMsg), "danger");
        },
        historyListener: {
            onPush: function (url) {
                history.replaceState(null, null, "#" + url);
            },
            onGet: function () {
                return hash;
            }
        }
    };
    var mainWindow = S.S("#mainWindow");
    var loginPanel = S.S("#loginPanel");
    var loginDiv = S.N("#loginDiv");

    S.on("s-ready", function () {

        loginPanel.load('login-panel.html');
        loginDiv.show();
        loginPanel.node.on("close", function (e, rs) {
            if (rs) {
                window.CURRENT_MANAGER = rs;
                mainWindow.load('layouts/main0.html', Page);
                loginDiv.remove();
            }
        });

        return;
        /**
         * 这里可以通过check登陆状态，判断加载主界面还是加载登陆页面
         * */
        S.get("/login/check").done(function (rs) {
            if (rs) {
                window.CURRENT_MANAGER = rs;
                mainWindow.load('layouts/main0.html', Page);
                loginDiv.remove();
            } else {
                loginPanel.load('login-panel.html');
                loginDiv.show();
                loginPanel.node.on("close", function (e, rs) {
                    if (rs) {
                        window.CURRENT_MANAGER = rs;
                        mainWindow.load('layouts/main0.html', Page);
                        loginDiv.remove();
                    }
                });
            }
        });
    })
</script>