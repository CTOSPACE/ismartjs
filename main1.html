<div class="topbar" >
    <div s="window" s-window-href="{Page.Main.topbarLeftUrl}" class="pull-left"></div>
    <div class="topbar-nav">
        <div class="topbar-nav-menu dropdown" >
            <a href="javascript:;" class="dropdown-toggle" data-toggle="dropdown">
                <em>菜单</em>
                <span class="caret"></span>
            </a>
            <div class="dropdown-menu" role="menu">
                <ul s="tpl" id="controlPanel">
                    {% $.each(this, function(i, menu){ %}
                    <li menuId="{%=menu.id%}" s="click" s-click-action="openMenuById('{%=menu.id%}')">
                        <a href="javascript:;">{%=menu.icon?'<i class="'+menu.icon+'"></i> ':''%}{%=menu.title%}</a></li>
                    {% }) %}
                </ul>
            </div>
        </div>
        <div class="topbar-nav-menu" >
            <a href="javascript:;" class="main-menu-arrow"><i class="glyphicon glyphicon-chevron-left"></i></a>
        </div>
    </div>
    <div class="pull-right topbar-right">
        <div class="topbar-nav-menu" >
            <a href="javascript:;" class="main-menu-arrow arrow-right" ><i class="glyphicon glyphicon-chevron-right"></i></a>
        </div>
        <div s="window" s-window-href="{Page.Main.topbarRightUrl}"></div>
    </div>
    <ul class="tab" id="mainMenuBar">

    </ul>


</div>
<!--ajax操作提示-->
<div class="alert alert-warning ajax-active-tip fade" role="alert" id="ajaxActiveTip"></div>
<div class="main-window" id="mainWindow">
    <div class="navbar" id="secondaryMenuNavbar" s="tpl" >
        <div class="navbar-title">{%=this.title%}</div>
        <ul class="navbar-nav" id="secondaryMenuBar">
            {% $.each(this.children, function(i,menu){ %}
            <li s="click" s-click-action="showMenuById('{%=menu.id%}')" menuId="{%=menu.id%}">{%=menu.title%}</li>
            {% }); %}
        </ul>
    </div>
    <div class="window-container" id="windowContainer">

    </div>
</div>
<div id="mainSidebar" class="main-sidebar" s="tpl">
    <ul class="nav">
        {% $.each(this, function(i, a){ %}
        <li anchorId="{%=a.id%}"><a href="javascript:;"  s="click" s-click-action="windowScrollTo(this, '{%=a.id%}')">{%=a.title%}</a></li>
        {%});%}
    </ul>
</div>

<ul id="mainMenuBarContextmenu" s="contextmenu" s-contextmenu-filter="mainMenuBarContextMenuFilter" class="s-ui-contextmenu" >
    <li menuId="close" s="click" s-click-action="closeByContextmenu()">
        <span>关闭</span>
    </li>
    <li class="s-ui-contextmenu-line"></li>
    <li menuId="clostOther" s="click" s-click-action="closeOtherByMainContextmenu()">
        <span>关闭其他</span>
    </li>
    <li menuId="closeAll" s="click" s-click-action="closeAllByMainContextmenu()">
        <span>关闭所有</span>
    </li>
    <li class="s-ui-contextmenu-line"></li>
    <li menuId="closeAll" s="click" s-click-action="refreshByMainContextmenu()">
        <span>刷新</span>
    </li>
</ul>

<script type="text/javascript">

function ControlPanel(menus){
    var that = this;
    this.menuIdMap = {};
    this.defaultOpenMenus = [];
    $.each(menus, function(i, menu){
        if(menu.open){
            that.defaultOpenMenus.push(menu);
        }
        if(!menu.icon) menu.icon = "glyphicon glyphicon-file";
        that.addMenu(menu);
        if(menu.children){
            $.each(menu.children, function(i, child){
                that.addMenu(child);
                child.parent = menu;
            });
        }
    });
}

ControlPanel.prototype = {
    getMenuById: function(id){
        return this.menuIdMap[id];
    },
    addMenu: function(menu){
        if(this.menuIdMap[menu.id]){
            Smart.error("menuId已经存在: " + menu.id);
            return;
        }
        this.menuIdMap[menu.id] = menu;
    }
};

var controlPanel;
//主菜单选项卡
var mainMenuBar = S.N("#mainMenuBar");
var windowContainer = S.N("#windowContainer");

mainMenuBar.sortable({ delay: 150 , axis: "x"});

S.S("#controlPanel").onMade(function(){
    var that = this;
    var menuUrl = Page.Main.menuUrl;
    if(Smart.isEmpty(menuUrl)){
        alert("Menu Url没有配置，请配置Smart.UI.menuUrl的值！");
        return;
    }
    //加载menu
    S.get(menuUrl).done(function(menu){
        controlPanel = new ControlPanel(menu);
        that.data(menu);
        if(controlPanel.defaultOpenMenus.length){
            $.each(controlPanel.defaultOpenMenus, function(i, menu){
                //打开菜单
                addMainMenuTab(menu);
            });
            openMenu(controlPanel.defaultOpenMenus[0]);
        }
        var hash = Page.Main.historyListener.onGet();
        if(hash.type == "u"){
            _openUrl(null, hash.value);
        } else {
            openMenuById(hash.value);
        }
    });
});

//加载usermenu
S.S("#topUserMenu").onMade(function(){
    this.load(Page.Main.topUserUrl);
});

var openMenuById = function(id){
    var menu = controlPanel.getMenuById(id);
    openMenu(menu);
};

var getMainMenuTabById = function(id){
    return $("li[menuId='"+id+"']", mainMenuBar);
};

//打开菜单
var openMenu = function(mainMenu, secondaryMenu, args){
    if(mainMenu.parent){
        openMenu(mainMenu.parent, mainMenu, args);
        return;
    }
    if($.isArray(secondaryMenu)){
        args = secondaryMenu;
        secondaryMenu = undefined;
    }
    var mainMenuBar = getMainMenuTabById(mainMenu.id);
    if(mainMenuBar.size() > 0){
        activeMainMenuTab(mainMenu, secondaryMenu);
        return;
    }
    addMainMenuTab(mainMenu);
    return activeMainMenuTab(mainMenu, secondaryMenu, args);
};

var mainMenuBarContextmenu = S.S("#mainMenuBarContextmenu");

//选项卡右键菜单过滤器
function mainMenuBarContextMenuFilter(menuId){
    if(menuId == "close"){
        var target = Smart.UI.contextmenu.target;
        var menuId = target.node.attr("menuId");
        var menu = controlPanel.getMenuById(menuId);
        return menu.open && menu.closeable != false;
    }
}

//主菜单选项卡的模板
var mainMenuBarTpl = '<li><a href="javascript:;"></a></li>';
var addMainMenuTab = function(menu){
    var li = $(mainMenuBarTpl);
    li.attr("menuId", menu.id);
    li.click(function(){
        activeMainMenuTab(menu, menu._shownMenu);
    });
    var a = $("a", li);
    if(menu.closeable || menu.closeable == undefined){
        var closeSpan = $("<div>×</div>");
        li.addClass("closeable").append(closeSpan);
        closeSpan.click(function(e){
            closeMainMenuTab(menu);
            showTopMainMenu();
            e.stopPropagation();
        });
    }
    var liInner = createMainMenuIcon(menu.icon) + menu.title;
    a.html(liInner);
    a.attr("title", menu.title);
    mainMenuBarContextmenu.bindTarget(li);
    mainMenuBar.append(li);
};

var mainSidebar = S.S("#mainSidebar");
var mainMenuBarIdStack = [];
var secondaryMenuNavbar = S.S("#secondaryMenuNavbar");
var activeMainMenuTab = function(menu, secondaryMenu, args){
    //如果当前要打开的id位于打开栈的顶端，则表明已经打开，则不进行任何操作；
    var li = $("li[menuId='"+menu.id+"']", mainMenuBar);
    if(li.hasClass("active")){
        return;
    }
    //保存menu打开栈
    mainMenuBarIdStack = Smart.removeArrayElement(menu.id, mainMenuBarIdStack);
    mainMenuBarIdStack.push(menu.id);
    var otherLi = li.siblings();
    otherLi.removeClass("active");
    $("i", otherLi).addClass("icon-white");
    li.addClass("active");
    $("i", li).removeClass("icon-white");
    if(menu.url){
        showSecondaryMenuNavbar(false);
        windowContainer.removeClass("navbar-on");
        return showMenu(menu, args);
    } else {
        secondaryMenuNavbar.data(menu);
        showSecondaryMenuNavbar(true);
        windowContainer.addClass("navbar-on");
        return showMenu(secondaryMenu || menu.children[0], args);
    }
}

function showSecondaryMenuNavbar(flag){
    if(!flag){
        secondaryMenuNavbar.node.hide();
        mainSidebar.node.removeClass("margin-navbar");
    } else {
        secondaryMenuNavbar.node.show();
        mainSidebar.node.addClass("margin-navbar");
    }
}

var closeMainMenuTab = function(menu){
    var closeMenus = [];
    if(menu.url){
        //如果一级菜单是url的形式，则说明没有children，则关闭当前菜单的window页。
        closeMenus.push(menu);
    } else {
        //如果一级菜单没有url，则说明打开的是其children，则关闭当前菜单children的window页。
        $.each(menu.children, function(i, child){
            closeMenus.push(child);
        });
    }
    var closeFns = [];
    var closeSmart = [];
    //删除打开的窗口
    $.each(closeMenus, function(i, menu){
        var node = getMenuWindowNode(menu.id);
        if(node.size() == 0){
            return;
        }
        var smart = menu._smart_;
        closeSmart.push(smart);
        closeFns.push(function(){
            var deferred = $.Deferred();
            smart.preClose().done(function(){
                deferred.resolve();
            }).fail(function(){
                //如果smart的close被reject，则打开当前的menu
                openMenu(menu);
                deferred.reject();
            });
            return deferred.promise();
        });
    });
    return Smart.deferredQueue(closeFns).done(function(){
        removeMainMenuTab(menu);
        $.each(closeSmart, function(i, smart){
            smart.close();
        });
    });
};

function removeMainMenuTab(menu){
    var tab = getMainMenuTabById(menu.id);
    tab.remove();
    mainMenuBarIdStack = Smart.removeArrayElement(menu.id, mainMenuBarIdStack);
}

function showTopMainMenu(){
    var cMenu = controlPanel.getMenuById(mainMenuBarIdStack[mainMenuBarIdStack.length - 1]);
    activeMainMenuTab(cMenu, cMenu._shownMenu);
}

function showMenuById(id){
    showMenu(controlPanel.getMenuById(id));
}

function showMenu(menu, args){
    var li = $("li[menuId='"+menu.id+"']",S.N("#secondaryMenuBar"));
    li.siblings().removeClass("active");
    li.addClass("active");
    var deferred = $.Deferred();
    var windowNode = getMenuWindowNode(menu.id);
    if(windowNode.size() == 0){
        windowNode = $("<div s='window' menuId='"+menu.id+"' />").html("正在加载……").hide();
        windowContainer.append(windowNode);
        hideVisibleWindow();
        showWindow(windowNode);
        var smart = Smart.of(windowNode);
//            extendWindowSmart(smart);
        //如果一级菜单通过url打开，则监听其close事件
        if(menu.parent == undefined){//如果没有parent，则为一级菜单
            //如果关闭的动作是通过点击主菜单关闭按钮的话，就不需要监听closeMainMenuTab事件
            smart.on("close", function(e){
                if(getMainMenuTabById(menu.id).size() > 0){
                    removeMainMenuTab(menu);
                    showTopMainMenu();
                }
            }).on("meta", function(e, key, value){
                setMainMenuMetaValue(menu.id, key, value);
            }).on("anchor.scrollin", function(e, id){
                activeSidebarItem(id);
            });
        }
        smart.make();
        //监听loading事件。
        smart.on("loading", function(){
            onMainMenuLoading(menu);
        });
        smart.on("load", function(){
            onMainMenuLoad(menu);
        });
        smart.load.apply(smart, [menu.url].concat(args)).done(function(s){
            deferred.resolve(s);
            buildSidebar(smart);
        });
        menu._smart_ = smart;
    } else {
        hideVisibleWindow();
        showWindow(windowNode);
        var windowSmart = Smart.of(windowNode);
        buildSidebar(windowSmart);
        deferred.resolve(windowSmart);
    }

    if(menu.parent){
        menu.parent._shownMenu = menu;
    }
    Page.Main.historyListener.onPush && Page.Main.historyListener.onPush(menu);
    return deferred;
}

//main window loading
function onMainMenuLoading(menu){
    if(menu.parent){
        menu = menu.parent;
    }
    var tab = getMainMenuTabById(menu.id);
    tab.addClass("loading");
}

function onMainMenuLoad(menu){
    if(menu.parent){
        menu = menu.parent;
    }
    var tab = getMainMenuTabById(menu.id);
    tab.removeClass("loading");
}

function hideVisibleWindow(){
    var window = windowContainer.children(":visible");
    window.hide();
}

function showWindow(node){
    node.fadeIn();
}

var currentWindowSmartForSidebar;
function buildSidebar(windowSmart){
    var list = windowSmart.getAnchors();
    if(list.length){
        currentWindowSmartForSidebar = windowSmart;
        mainSidebar.data(list);
        mainSidebar.node.fadeIn();
        windowSmart.node.addClass("padding-sidebar");
    } else {
        mainSidebar.node.hide();
        currentWindowSmartForSidebar = null;
        windowSmart.node.removeClass("padding-sidebar");
    }
}
function windowScrollTo(smart, id){
    currentWindowSmartForSidebar && currentWindowSmartForSidebar.scrollToAnchor(id);
    activeSidebarItem(id);
}

function activeSidebarItem(id){
    mainSidebar.node.find("a.active").removeClass("active");
    mainSidebar.node.find("li[anchorId='"+id+"'] a").addClass("active");
}

function getMenuWindowNode(id){
    return $("div[menuId='"+id+"']", windowContainer);
}

var menuIdToken = 0;

function getUniqueMenuIdForUrl(){
    return "__menuIdForUrl___" + (menuIdToken++);
}

function setMainMenuMeta(id, meta){
    var tab = getMainMenuTabById(id);
    var aHtml = "<span>"+meta.title+"</span>";
    aHtml = createMainMenuIcon(meta.icon) + aHtml;
    var a = $("a", tab);
    a.html(aHtml);
    if(meta.description){
        a.attr("title", meta.description);
    } else {
        a.attr("title", meta.title);
    }
}

function setMainMenuMetaValue(id, key, value){
    var tab = getMainMenuTabById(id);
    var a = $("a", tab);
    if(key == "title"){
        $("span", a).html(value);
    } else if(key == "icon"){
        var icon = $("i", a);
        if(icon.size() > 0){
            icon.remove();
            if(value == ""){
                return;
            }
        }
        if(Smart.isEmpty(value)){
            return;
        }
        a.prepend(createMainMenuIcon(value))
    } else if(key == "description"){
        a.attr("title", value == undefined ? "" : value);
    }
}

function createMainMenuIcon(icon){
    if(!icon){
        icon = Page.Main.defaultIcon;
    }
    return "<i class='"+icon+"'></i> "
}

var _openUrl = function(deferred, url){
    //根据当前控件的url处理 打开的url的真实路径。
    var menu = {
        title:"加载中",
        id: getUniqueMenuIdForUrl(),
        _type: "url",
        url: url
    }
    controlPanel.addMenu(menu);
    openMenu(menu, Smart.SLICE.call(arguments, 1)).done(function(smart){
        smart.on("close", function(e){
            deferred && deferred.resolve.apply(deferred, Smart.SLICE.call(arguments, 1));
        });
    }).done(function(smart){
        setMainMenuMeta(menu.id, smart.meta);
    });
};

S.on("open", function(e, url){
    if(/^url:.+$/gi.test(url)){
        url = url.substring(4);
        var nowUrl = e.smart.currentHref();
        if(!Smart.isEmpty(nowUrl)){
            url = Smart.realPath(url, nowUrl);
        }
        return _openUrl.apply(null, [e.deferred, url].concat(Smart.SLICE.call(arguments, 2)));
    } if(/^menu:.+$/gi.test(url)){
        openMenuById(url.substring(5));
    } else {
        Smart.error("open的参数必须以url:或者menu:为开头，代表打开url或者id为值的menu");
    }
    e.stopPropagation();
});

//    var extendApi = {
//        open: function(key){
//            if(/^url:.+$/gi.test(key)){
//                return _openUrl.apply(this, [key.substring(4)].concat(Smart.SLICE.call(arguments, 1)));
//            } if(/^menu:.+$/gi.test(key)){
//                openMenuById(key.substring(5));
//            } else {
//                Smart.error("open的参数必须以url:或者menu:为开头，代表打开url或者id为值的menu");
//            }
//        }
//    };

//    function extendWindowSmart(smart){
//        $.extend(smart, extendApi);
//    }
//
//    //选项卡右键菜单
//    //根据右键菜单关闭tab

function getContextmenuTabMenu(){
    var target = Smart.UI.contextmenu.target;
    var menuId = target.node.attr("menuId");
    return controlPanel.getMenuById(menuId);
}

function closeByContextmenu(){
    closeMainMenuTab(getContextmenuTabMenu()).done(function(){
        showTopMainMenu();
    });
}

function closeOtherByMainContextmenu(){
    var menu = getContextmenuTabMenu();
    //activeMainMenuTab(menu);
    var closeDeferreds = [];
    for(var i = mainMenuBarIdStack.length - 1; i >= 0 ; i--){
        var m = controlPanel.getMenuById(mainMenuBarIdStack[i]);
        if(m.id == menu.id) continue;
        if(m.open && m.closeable == false) continue;
        (function(m){
            closeDeferreds.push(function(){
                return closeMainMenuTab(m);
            });
        })(m)
    }
    Smart.deferredQueue(closeDeferreds).done(function(){
        activeMainMenuTab(menu);
    });
}

function closeAllByMainContextmenu(){
    var closeDeferreds = [];
    for(var i = mainMenuBarIdStack.length - 1; i >= 0 ; i--){
        var m = controlPanel.getMenuById(mainMenuBarIdStack[i]);
        if(m.open && m.closeable == false) continue;
        (function(m){
            closeDeferreds.push(function(){
                return closeMainMenuTab(m);
            });
        })(m)
    }
    Smart.deferredQueue(closeDeferreds).done(function(){
        mainMenuBarIdStack.length && activeMainMenuTab(controlPanel.getMenuById(mainMenuBarIdStack[mainMenuBarIdStack.length - 1]));
    });
}

function refreshByMainContextmenu(){
    var menu = getContextmenuTabMenu();
    if(menu._shownMenu)
        menu._shownMenu._smart_.refresh();
    else
        menu._smart_.refresh();
}

//处理ajax tip
var ajaxActiveTip = S.N("#ajaxActiveTip");
var closeTimeout;
function showAjaxActiveTip(msg, level){
    var removeClass;
    var addClass;
    if(level == "warning"){
        removeClass = "alert-success alert-danger";
        addClass = "alert-warning";
    } else if(level == "success"){
        removeClass = "alert-warning alert-danger";
        addClass = "alert-success";
    } else {
        removeClass = "alert-warning alert-success";
        addClass = "alert-danger";
    }
    ajaxActiveTip.removeClass(removeClass).addClass(addClass+" in").css('z-index', Smart.UI.zIndex()).html(msg);
}
function hideAjaxActiveTip(){
    if(closeTimeout){
        clearTimeout(closeTimeout);
    }
    closeTimeout = setTimeout(function(){
        ajaxActiveTip.removeClass('in');
        closeTimeout = 0;
    }, 1500);
}
$("body").on("ajaxStart", function(e, tip){
    showAjaxActiveTip(tip, "warning");
}).on("ajaxSuccess", function(e, tip){
    showAjaxActiveTip(tip, "success");
    hideAjaxActiveTip();
}).on("ajaxError", function(e, errorTip, msg){
    S.alert($.trim(msg), "error");
    showAjaxActiveTip(errorTip, "error");
    hideAjaxActiveTip();
});
</script>