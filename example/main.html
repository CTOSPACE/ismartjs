<div class="topbar" >
    <div s="window" s-window-href="{Page.Main.topbarLeftUrl}" class="pull-left"></div>
    <div class="topbar-nav">
        <div class="topbar-nav-menu dropdown" >
            <a href="javascript:;" class="dropdown-toggle" data-toggle="dropdown">
                <em>菜单</em>
                <span class="caret"></span>
            </a>
            <div class="dropdown-menu" role="menu" id="menuPanel" s="tpl">
            {%if(this.topMenus.length){%}
                <div>
                    <ul>
                        {% $.each(this.topMenus, function(i, menu){ %}
                        <li menuId="{%=menu.id%}" s="click" s-click-action="openMenuById('{%=menu.id%}')">
                            <a href="javascript:;"><i class="{%=menu.icon%}"></i> {%=menu.title%}</a></li>
                        {% }) %}
                    </ul>
                </div>
            {%}%}
            {% $.each(this.levelMenus, function(i, menu){ %}
                <div>
                    <h5><i class="{%=menu.icon%}"></i> {%=menu.title%}</h5>
                    <ul>
                    {% $.each(this.children, function(i, c){ %}
                        <li menuId="{%=c.id%}" s="click" s-click-action="openMenuById('{%=c.id%}')">
                            <a href="javascript:;">{%=c.icon?'<i class="'+c.icon+'"></i> ':''%}{%=c.title%}</a></li>
                    {% }) %}
                    </ul>
                </div>
            {% }) %}

            </div>
        </div>
        <div class="topbar-nav-menu" >
            <a href="javascript:;" class="main-menu-arrow"><i class="glyphicon glyphicon-chevron-left"></i></a>
        </div>
    </div>
    <div class="pull-right topbar-right">
        <div class="topbar-nav-menu" >
            <a href="javascript:;" class="main-menu-arrow arrow-right" ><i class="glyphicon glyphicon-chevron-right"></i></a>
        </div>
        <div s="window" s-window-href="{Page.Main.topbarRightUrl}"></div>
    </div>
    <ul class="tab" id="mainTabContainer">

    </ul>


</div>
<!--ajax操作提示-->
<div class="alert alert-warning ajax-active-tip " role="alert" id="ajaxActiveTip"></div>

<div class="main-window" id="mainWindow">
    <div class="navbar" id="secondaryTabPanel" s="tpl" >
        <div class="navbar-title">{%=this.title%}</div>
        <ul class="navbar-nav" id="secondaryTabContainer">
            {% $.each(this.children, function(i,data){ %}
            <li s="click" s-click-action="showTabWindowById('{%=data.tabWindowId%}')" tabWindowId="{%=data.tabWindowId%}" >{%=data.title%}</li>
            {% }); %}
        </ul>
    </div>
    <div class="window-container" id="windowContainer">

    </div>
</div>

<ul id="mainTabContextmenu" s="contextmenu" s-contextmenu-filter="MainTabContextmenu.filter" class="s-ui-contextmenu" >
    <li menuId="close" s="click" s-click-action="MainTabContextmenu.closeTarget()">
        <span>关闭</span>
    </li>
    <li class="s-ui-contextmenu-line"></li>
    <li menuId="clostOther" s="click" s-click-action="MainTabContextmenu.closeOthers()">
        <span>关闭其他</span>
    </li>
    <li menuId="closeAll" s="click" s-click-action="MainTabContextmenu.closeAll()">
        <span>关闭所有</span>
    </li>
    <li class="s-ui-contextmenu-line"></li>
    <li menuId="refresh" s="click" s-click-action="MainTabContextmenu.refreshTarget()">
        <span>刷新</span>
    </li>
</ul>

<ul id="mainContextmenu" s="contextmenu" class="s-ui-contextmenu">
    <li menuId="showSource" s="click" s-click-action="MainContextmenu.showSourceHtml(e)">
        <span>查看源码</span>
    </li>
    <li class="s-ui-contextmenu-line"></li>
    <li menuId="copyright" s="click" s-click-action="MainContextmenu.showCopyright()"><span>版权声明</span></li>
</ul>

<script type="text/javascript">

    function openMenuById(id){
        var menu = MenuPanel.getMenuById(id);
        new MainTab(menu).add().active();
    }

    S.on("open", function(e, url){
        if(/^menu:.+$/gi.test(url)){
            openMenuById(url.substring(5));
        } else {
            if(url.indexOf("url:") == 0) url = url.substring(4);
            var nowUrl = e.smart.widget.window.location.href;
            if(!Smart.isEmpty(nowUrl)){
                url = Smart.realPath(url, nowUrl);
            }
            openUrl.apply(null, [e.deferred, url].concat(Smart.SLICE.call(arguments, 2)));
        }
        e.stopPropagation();
    });

    var openUrl = function(deferred, url){
        //根据当前控件的url处理 打开的url的真实路径。
        var data = {
            title:"加载中",
            type: "url",
            url: url,
            deferred: deferred
        };
        new MainTab(data).add().active();
    };

    //菜单面板
    var MenuPanel = {
        smart: S.S("#menuPanel"),
        menuMapping: {},
        loadMenu: function(){
            var menuUrl = Page.Main.menuUrl;
            if(Smart.isEmpty(menuUrl)){
                return;
            }
            var that = this;
            S.get(menuUrl).done(function(menus){
                that.menus = menus;
                var urlMapping = {};
                var needOpenMenus = [];
                var topMenus = [];//顶级菜单，即一级菜单没有子菜单的菜单，默认级别最高
                var levelMenus= [];//一级菜单拥有子菜单的菜单
                $.each(menus, function(i, menu){
                    urlMapping[menu.url] = menu;
                    menu.icon = menu.icon || Page.Main.defaultMenuIcon;
                    that.menuMapping[menu.id] = menu;
                    //顶级菜单如果没有子菜单，则允许其打开
                    if(menu.open && !menu.children) needOpenMenus.push(menu);
                    
                    if(!Smart.isEmpty(menu.children)){
                        levelMenus.push(menu);
                        $.each(menu.children, function(i, c){
                            if((c.closeable != undefined && c.closeable == false)){
                                //如果menu不允许关闭
                                needOpenMenus.push(c);
                                return;
                            }
                            if(c.open) needOpenMenus.push(c);
                            c.icon = c.icon || Page.Main.defaultMenuIcon;
                            that.menuMapping[c.id] = c;
                            urlMapping[c.url] = c;
                            c.parent = menu;
                            if(!Smart.isEmpty(c.children)){
                                $.each(c.children, function(i, cc){
                                    that.menuMapping[cc.id] = cc;
                                    urlMapping[cc.url] = cc;
                                    cc.parent = c;
                                    cc.icon = cc.icon || Page.Main.defaultMenuIcon;
                                });
                            }
                        });
                    } else {
                        topMenus.push(menu);
                    }
                });
                that.smart.data({topMenus: topMenus, levelMenus: levelMenus});
                var openMainTab;
                //如果根据hash要打开的页面的url和默认需要打开的有相同的，则不需要创建新的，直接将已经打开的置为active。
                var openedUrlMap = {};
                var hash = Page.Main.historyListener.onGet();
                $.each(needOpenMenus, function(i, m){
                    var _openMainTab ;
                    if(!m.url){
                        var flag = false;
                        $.each(m.children, function(j, c){
                            if(c.url == hash){
                                _openMainTab = openedUrlMap[c.url] = new MainTab(m, c).add();
                                flag = true;
                                return false;
                            }
                        });
                        if(!flag){
                            _openMainTab = openedUrlMap[m.url] = new MainTab(m).add();
                        }
                    } else {
                        _openMainTab = openedUrlMap[m.url] = new MainTab(m).add();
                    }
                    if(i == 0){
                        openMainTab = _openMainTab;
                    }
                });
                if(hash){
                    if(hash in openedUrlMap){
                        openedUrlMap[hash].active();
                    } else if(hash in urlMapping){
                        var menu = urlMapping[hash];
                        var topMenu, secondaryMenu;
                        if(menu.parent){
                            if(menu.parent.parent){
                                //如果打开的是3级菜单，则需要打开2级主菜单
                                topMenu = menu.parent;
                                secondaryMenu = menu;
                            } else {
                                //如果不是，则直接打开菜单
                                topMenu = menu;
                            }
                        } else {
                            topMenu = menu;
                        }
                        new MainTab(topMenu, secondaryMenu).add().active();
                    } else {
                        openUrl(null, hash);
                    }
                } else {
                    openMainTab && openMainTab.active();
                }
            });
            return this;
        },
        getMenuById: function(id){
            return this.menuMapping[id];
        }
    };

    S.on("window.document.ready", function(){
        MenuPanel.loadMenu();
    });

    //主选项
    function MainTab(data, secondaryMenu){
        this.data = data;
        this.tabWindows = [];
        this.secondaryTabData = {
            title : data.title,
            children: []
        };
        if(Smart.isEmpty(this.data.children)){
            var tabWindow = new TabWindow(this.data, this);
            this.bindTabWindowEvent(tabWindow);
            this.tabWindows.push(tabWindow);
        } else {
            var that = this;
            $.each(this.data.children, function(i, d){
                var tabWindow = new TabWindow(d, that);
                that.tabWindows.push(tabWindow);
                if(d == secondaryMenu){
                    that.currentTabWindow = tabWindow;
                }
                that.bindTabWindowEvent(tabWindow);
                that.secondaryTabData.children.push({
                    title: d.title,
                    tabWindowId: tabWindow.id
                });
            });
        }
        this.currentTabWindow = this.currentTabWindow || this.tabWindows[0];
    }

    MainTab.container = S.N("#mainTabContainer");
    MainTab.currentTab = null;
    MainTab.TabStack = {
        stack: [],
        pushTop: function(mainTab){
            if(this.stack.length){
                if(this.stack[this.stack.length - 1] == mainTab){
                    return;
                }
            }
            this.stack = Smart.removeArrayElement(mainTab, this.stack);
            this.stack.push(mainTab);
        },
        getTop: function(){
            if(this.stack.length){
                return this.stack[this.stack.length - 1];
            }
            return null;
        },
        remove: function(mainTab){
            this.stack = Smart.removeArrayElement(mainTab, this.stack);
        }
    };
    MainTab.activeTop = function(){
        var topTab = MainTab.TabStack.getTop();
        topTab && topTab.active();
    };

    MainTab.closeMainTabs = function(mainTabs){
        var deferred = $.Deferred();
        function closeMainTab(i){
            if(i >= mainTabs.length){
                return deferred.resolve();
            }
            mainTabs[i].close().done(function(){
                closeMainTab(i + 1);
            })
        }
        closeMainTab(0);
        return deferred;
    }

    MainTab.prototype = {
        add: function () {
            this.node = $('<li><a href="javascript:;"></a></li>');
            var a = $("a", this.node);
            if (this.data.closeable || this.data.closeable == undefined) {
                var closeSpan = $("<div>×</div>");
                this.node.addClass("closeable").append(closeSpan);
                this.closeHandle = closeSpan;
            }
            var data = this.data;
            this.titleNode = $("<span> " + data.title + "</span>");
            this.iconNode = $("<i class='" + (data.icon ? data.icon : Page.Main.defaultTabIcon) + "'></i> ");
            a.append(this.iconNode);
            a.append(this.titleNode);
            this.node.attr("title", data.title);
            this.bindEvent();
            MainTabContextmenu.bindTarget(this.node, this);
            MainTab.container.append(this.node);
            MainTab.TabStack.pushTop(this);
            return this;
        },
        bindEvent: function () {
            var that = this;
            this.closeHandle && this.closeHandle.click(function(){
                that.close();
                //MainTab.activeTop();
            });
            this.node.click($.proxy(this.active, this));
            return this;
        },
        close: function () {
            var that = this;
            var deferred = $.Deferred();
            function closeTabWindow(i){
                if(i >= that.tabWindows.length){
                    //如果拥有2级菜单的话，这里需要处理activeTop,没有2级菜单的在监听TabWindow的close事件中已经处理了activeTop了
                    if(!Smart.isEmpty(that.data.children)){
                        that.destroy();
                        MainTab.activeTop();
                    }

                    return deferred.resolve();
                }
                var tabWindow = that.tabWindows[i];
                tabWindow.close().done(function(){
                    closeTabWindow(i + 1);
                });
            }
            closeTabWindow(0);
            return deferred;
        },
        refresh: function(){
            this.currentTabWindow.refresh();
        },
        active: function () {
            if(MainTab.currentTab == this){
                return;
            }
            if(MainTab.currentTab){
                MainTab.currentTab.fallow();
            }
            MainTab.currentTab = this;
            this.node.addClass("active");
            MainTab.TabStack.pushTop(this);
            if(!Smart.isEmpty(this.data.children)){
                SecondaryTabPanel.show(this.secondaryTabData, this.currentTabWindow.id);
            }
            this.showTabWindow();
            return this;
        },
        fallow: function(){
            this.node.removeClass("active");
            if(!Smart.isEmpty(this.data.children)){
                SecondaryTabPanel.hide();
            }
            return this;
        },
        destroy: function(){
            this.node.remove();
            MainTab.TabStack.remove(this);
        },
        showTabWindow: function(){
            if(!this.currentTabWindow.made){
                this.makeTabWindow(this.currentTabWindow);
            }
            this.currentTabWindow.show();
            return this;
        },
        makeTabWindow: function(tabWindow){

            var that = this;
            if(Smart.isEmpty(this.data.children)){
                tabWindow.smart.on("meta", function(e, key, value){
                    if($.type(key) == 'object'){
                        that.setMeta(key);
                    } else {
                        var meta = {};
                        meta[key] = value;
                        that.setMeta(meta);
                    }
                });
            }
            tabWindow.make().done(function(smart){
                that.setMeta(smart.meta);
            });
        },
        bindTabWindowEvent: function(tabWindow){
            var that = this;
            tabWindow.smart.on("close", function(){
                that.destroy();
                MainTab.activeTop();
            }).on("loading", function(){
                that.node.addClass("loading");
            }).on("load", function(){
                that.node.removeClass("loading");
            });
        },
        setMeta:function(meta){
            var that = this;
            $.each(meta || {}, function(key, value){
                switch(key){
                    case "title": that.titleNode.html(" " + value); that.node.attr("title", value); break;
                    case "icon" : that.iconNode.attr("class", "").addClass(value);break;
                    case "description": that.node.attr("title", value);break;
                }
            });
        }
    };

    var MainTabContextmenu = {
        smart: S.S("#mainTabContextmenu"),
        bindTarget: function(node, mainTab){
            node.data("mainTab", mainTab);
            this.smart.bindTarget(node);
        },
        filter: function(menuId){
            if(menuId == "close"){
                var target = Smart.UI.contextmenu.target;
                var mainTab = target.node.data("mainTab");
                var data = mainTab.data;
                return data.open && data.closeable != false;
            }
        },
        closeTarget: function(){
            var target = Smart.UI.contextmenu.target;
            var mainTab = target.node.data("mainTab");
            mainTab.close();
            MainTab.activeTop();
        },
        closeOthers: function(){
            var target = Smart.UI.contextmenu.target;
            var others = target.node.siblings();
            this.closeNodes(others);
        },
        closeAll: function(){
            var tabs = MainTab.container.children();
            this.closeNodes(tabs);
        },
        closeNodes: function(nodes){
            var mainTabs = [];
            $.each(nodes, function(){
                var mainTab = $(this).data("mainTab");
                if(mainTab.data.open && mainTab.data.closeable == false) return;
                mainTabs.push(mainTab);
            });
            MainTab.closeMainTabs(mainTabs).done(function(){
                MainTab.activeTop();
            });
        },
        refreshTarget: function(){
            var target = Smart.UI.contextmenu.target;
            var mainTab = target.node.data("mainTab");
            mainTab.refresh();
        }
    };

    var MainContextmenu = {
        smart: S.S("#mainContextmenu"),
        bindTarget: function(node, mainTab){
            node.data("mainTab", mainTab);
            this.smart.bindTarget(node);
        },
        showCopyright: function(){
            S.alert("iSmart JS 版权所有，QQ群：51729123");
        },
        showSourceHtml: function(){
            var node = Smart.UI.contextmenu.node;
            var windowSmart = Smart.of(node).closest('window');
            if(windowSmart == null) return;
            var menu = {
                url: 'source-view.html',
                args:[{url:windowSmart.widget.window.location.href}]};
            new MainTab(menu).add().active();
        }
    };

    this.on("window.document.ready", function(){
        MainContextmenu.bindTarget(S.node);
    });

    var SecondaryTabPanel = {
        smart: S.S("#secondaryTabPanel"),
        show: function(data, tabWindowId){
            this.smart.node.show();
            this.smart.data(data);
            this.activeTab(tabWindowId);
            TabWindow.container.addClass("navbar-on");
        },
        hide: function(){
            this.smart.node.hide();
            TabWindow.container.removeClass("navbar-on");
        },
        activeTab: function(id){
            if(!id) return;
            var li = S.N("#secondaryTabContainer").children("li[tabWindowId="+id+"]");
            li.siblings(".active").removeClass("active");
            li.addClass('active');
        }
    };

    function showTabWindowById(id){
        var tabWindow = TabWindow.mapping[id];
        !tabWindow.made && tabWindow.make();
        tabWindow.show();
        SecondaryTabPanel.activeTab(id);
    }

    function TabWindow(data, mainTab){
        this.data = data
        this.made = false;
        this.mainTab = mainTab;
        this.id = TabWindow.getToken();
        TabWindow.mapping[this.id] = this;
        this.node = $("<div s='window' />").html("正在加载……");
        this.smart = Smart.of(this.node);
    }
    TabWindow.container = S.N("#windowContainer");
    TabWindow.currentTabWindow = null;
    TabWindow.token = 0;
    TabWindow.getToken = function(){
        return "_tab_window_" + (TabWindow.token ++ );
    };
    TabWindow.mapping = {};
    TabWindow.prototype = {
        show: function(){
            if(TabWindow.currentTabWindow){
                TabWindow.currentTabWindow.hide();
            }
            TabWindow.currentTabWindow = this;
            this.mainTab.currentTabWindow = this;
            this.node.fadeIn();
            if(this.data.url) Page.Main.historyListener.onPush(this.data.url);
        },
        hide: function(){
            this.node.hide();
        },
        make: function(){
            this.made = true;
            this.smart.make();
            TabWindow.container.append(this.node);
            if(!this.data.url) return $.Deferred().resolve(this.smart);
            return this.smart.load.apply(this.smart, [this.data.url].concat(this.data.args));
        },
        close: function(){
            if(!this.made) {
                this.smart.trigger("close");//因为MainTab的关闭是监听的该smart的close事件，如果没有made，则在这里直接trigger一个close事件
                return $.Deferred().resolve();
            }
            var that = this;
            return this.smart.closeWithConfirm().done(function(){
                delete TabWindow.mapping[that.id];
                delete that.mainTab.currentTabWindow;
                delete that.mainTab;
            });
        },
        refresh: function(){
            this.smart.refresh();
        }
    };

    //处理ajax tip
    var ajaxActiveTip = S.N("#ajaxActiveTip");
    var closeTimeout;
    function showAjaxActiveTip(msg, level){
        var removeClass;
        var addClass;
        if(level == "warning"){
            removeClass = "alert-success alert-danger";
            addClass = "alert-warning";
        } else if(level == "success"){
            removeClass = "alert-warning alert-danger";
            addClass = "alert-success";
        } else {
            removeClass = "alert-warning alert-success";
            addClass = "alert-danger";
        }
        ajaxActiveTip.removeClass(removeClass).addClass(addClass).css('z-index', Smart.UI.zIndex()).show().html(msg);
    }
    function hideAjaxActiveTip(){
        if(closeTimeout){
            clearTimeout(closeTimeout);
        }
        closeTimeout = setTimeout(function(){
            ajaxActiveTip.fadeOut(200);
            closeTimeout = 0;
        }, 1500);
    }
    $("body").on("smart-ajaxStart", function(e, tip){
        showAjaxActiveTip(tip, "warning");
    }).on("smart-ajaxSuccess", function(e, tip){
        showAjaxActiveTip(tip, "success");
        hideAjaxActiveTip();
    }).on("smart-ajaxError", function(e, errorTip, msg){
        S.alert($.trim(msg), "error");
        showAjaxActiveTip(errorTip, "error");
        hideAjaxActiveTip();
    });
</script>